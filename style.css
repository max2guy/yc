// ==========================================
// ì—°ì²œì¥ë¡œêµíšŒ ì²­ë…„ë¶€ ê¸°ë„ ë„¤íŠ¸ì›Œí¬ (Final v13 - More Options Menu)
// ==========================================

// 1. ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(function(registration) {
        registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    document.getElementById('update-toast').classList.add('show');
                }
            });
        });
    }, function(err) { console.log('SW Fail: ', err); });
}

// PWA ì„¤ì¹˜ ë²„íŠ¼ ë¡œì§
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBtn = document.getElementById('installBtn');
    if (installBtn) {
        installBtn.style.display = 'block';
        installBtn.onclick = () => {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((result) => {
                if (result.outcome === 'accepted') installBtn.style.display = 'none';
                deferredPrompt = null;
            });
        };
    }
});

// UI í•¸ë“¤ëŸ¬
let isFabOpen = false;
function toggleFabMenu() {
    isFabOpen = !isFabOpen;
    const container = document.getElementById('menu-container');
    if(isFabOpen) container.classList.add('menu-open');
    else container.classList.remove('menu-open');
}
document.body.addEventListener('click', (e) => {
    if(isFabOpen && !e.target.closest('#menu-container')) { toggleFabMenu(); }
    // í™”ë©´ í´ë¦­ ì‹œ ì—´ë ¤ìˆëŠ” ë”ë³´ê¸° ë©”ë‰´ ë‹«ê¸°
    if (!e.target.closest('.more-btn')) {
        document.querySelectorAll('.more-options').forEach(el => el.classList.remove('active'));
    }
});

function forceRefresh() {
    if(confirm("í™”ë©´ì„ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìºì‹œëœ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤)")) {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) registration.unregister();
            });
        }
        if ('caches' in window) {
            caches.keys().then(function(names) {
                for (let name of names) caches.delete(name);
                window.location.reload(true);
            });
        } else { window.location.reload(true); }
    }
}

// 2. Firebase ì„¤ì •
const firebaseConfig = {
    apiKey: "AIzaSyAF-L1RGBMb_uZBR4a3Aj0OVFu_KjccWZQ",
    authDomain: "ycprayer-7eac2.firebaseapp.com",
    databaseURL: "https://ycprayer-7eac2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ycprayer-7eac2",
    storageBucket: "ycprayer-7eac2.firebasestorage.app",
    messagingSenderId: "308314713888",
    appId: "1:308314713888:web:dc52dc7ba1ac7b76153145",
    measurementId: "G-XGEMDBQG2J"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const membersRef = database.ref('members');
const centerNodeRef = database.ref('centerNode');
const onlineRef = database.ref('.info/connected');
const presenceRef = database.ref('presence');
const messagesRef = database.ref('messages');

let mySessionId = localStorage.getItem('mySessionId');
if (!mySessionId) {
    mySessionId = 'user_' + Date.now();
    localStorage.setItem('mySessionId', mySessionId);
}

// 3. ë³€ìˆ˜ ë° ìƒíƒœ
let isAdmin = false;
let isFirstRender = true;
let readStatus = JSON.parse(localStorage.getItem('readStatus')) || {};
let isNotiEnabled = localStorage.getItem('isNotiEnabled') !== 'false'; 

let newMemberIds = new Set();
let globalNodes = [];
let simulation = null;
const loadTime = Date.now();
let unreadChatKeys = new Set();
let touchStartTime = 0;
let touchStartX = 0;
let touchStartY = 0;
let isTouchMove = false;
let dragStartX = 0;
let dragStartY = 0;
let isDragAction = false;
const brightColors = ["#FFCDD2", "#F8BBD0", "#E1BEE7", "#D1C4E9", "#C5CAE9", "#BBDEFB", "#B3E5FC", "#B2EBF2", "#B2DFDB", "#C8E6C9", "#DCEDC8", "#F0F4C3", "#FFF9C4", "#FFECB3", "#FFE0B2", "#FFCCBC", "#D7CCC8", "#F5F5F5", "#CFD8DC"];

let lastChatReadTime = Number(localStorage.getItem('lastChatReadTime')) || Date.now();

// ì„¤ì • ë° ì•Œë¦¼ ê¸°ëŠ¥ ë¡œì§ë“¤
function openSettingsModal() {
    const notiToggle = document.getElementById('setting-noti-toggle');
    if (isNotiEnabled && Notification.permission === "granted") notiToggle.checked = true;
    else notiToggle.checked = false;
    const adminToggle = document.getElementById('setting-admin-toggle');
    adminToggle.checked = isAdmin;
    document.getElementById('settings-modal').classList.add('active');
    if(isFabOpen) toggleFabMenu();
}
function closeSettingsModal() { document.getElementById('settings-modal').classList.remove('active'); }

function handleNotiToggle(checkbox) {
    if (checkbox.checked) {
        if (!("Notification" in window)) { alert("ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); checkbox.checked = false; return; }
        Notification.requestPermission().then(permission => {
            if (permission === "granted") enableNotification(); 
            else { alert("ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤."); checkbox.checked = false; }
        });
    } else {
        isNotiEnabled = false;
        localStorage.setItem('isNotiEnabled', 'false');
        updateNotiButtonUI();
        alert("ì•Œë¦¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
}

function handleAdminToggle(checkbox) {
    if (checkbox.checked) { checkbox.checked = false; openAdminModal(); }
    else {
        if (confirm("ê´€ë¦¬ì ëª¨ë“œë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            firebase.auth().signOut().then(() => { isAdmin = false; alert("ê´€ë¦¬ì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); });
        } else { checkbox.checked = true; }
    }
}

function toggleNotification() {
    if (isNotiEnabled) {
        isNotiEnabled = false; localStorage.setItem('isNotiEnabled', 'false');
        updateNotiButtonUI(); alert("ì•Œë¦¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ”•");
    } else {
        if (!("Notification" in window)) return alert("ì´ ê¸°ê¸°ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        if (Notification.permission === "granted") enableNotification();
        else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") enableNotification();
                else alert("ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            });
        } else alert("ì•Œë¦¼ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
    }
}

function enableNotification() {
    isNotiEnabled = true; localStorage.setItem('isNotiEnabled', 'true');
    updateNotiButtonUI();
    const toggle = document.getElementById('setting-noti-toggle');
    if(toggle) toggle.checked = true;
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(reg => {
            reg.showNotification("ì•Œë¦¼ ì„¤ì • ì™„ë£Œ!", { body: "ì´ì œë¶€í„° ì•Œë¦¼ì„ ë°›ì•„ë³´ì„¸ìš”.", icon: 'icon-192.png', vibrate: [100] });
        });
    }
}

function updateNotiButtonUI() {
    const btn = document.getElementById('noti-btn');
    const toggle = document.getElementById('setting-noti-toggle');
    if (btn) {
        if (isNotiEnabled) { btn.innerText = "ğŸ”• ì•Œë¦¼ ë„ê¸°"; btn.style.backgroundColor = "#FFCDD2"; btn.style.borderColor = "#EF9A9A"; }
        else { btn.innerText = "ğŸ”” ì•Œë¦¼ ì¼œê¸°"; btn.style.backgroundColor = "#FFF3E0"; btn.style.borderColor = "#FF9800"; }
    }
    if(toggle) toggle.checked = isNotiEnabled;
}
setTimeout(updateNotiButtonUI, 500);

// ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™”
function loadData() {
    setTimeout(() => { document.getElementById('loading').classList.add('hide'); if (!isDataLoaded) { updateGraph(); fetchWeather(); } }, 3000);
    Promise.all([membersRef.once('value'), centerNodeRef.once('value')])
    .then(([mSnap, cSnap]) => {
        const mData = mSnap.val(); const cData = cSnap.val();
        if (mData) members = Object.keys(mData).map(key => ({ firebaseKey: key, ...mData[key] }));
        if(cData && cData.icon) centerNode.icon = cData.icon;
        members.forEach(m => { if(!m.rotationDirection) m.rotationDirection = Math.random() < 0.5 ? 1 : -1; if(m.rotation === undefined) m.rotation = 0; });
        isDataLoaded = true; document.getElementById('loading').classList.add('hide');
        updateGraph(); fetchWeather(); setTimeout(() => { isFirstRender = false; }, 5000);
    }).catch(err => { console.log("Firebase Load Error:", err); document.getElementById('loading').classList.add('hide'); updateGraph(); });
}
loadData();

// Firebase ë¦¬ìŠ¤ë„ˆ ë° ê´€ë¦¬ ê¸°ëŠ¥ë“¤ (addNewMember, deleteMember, saveProfileChanges ë“± ê¸°ì¡´ ë¡œì§ ìœ ì§€)
function checkAdmin() { 
    const inputPw = document.getElementById('admin-pw').value; const adminEmail = "admin@church.com"; 
    firebase.auth().signInWithEmailAndPassword(adminEmail, inputPw)
    .then(() => {
        document.getElementById('admin-modal').classList.remove('active'); alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±! í™˜ì˜í•©ë‹ˆë‹¤.");
        document.getElementById('admin-pw').value=""; 
        const adminToggle = document.getElementById('setting-admin-toggle'); if(adminToggle) adminToggle.checked = true;
        if(currentMemberData) renderPrayers();
    }).catch((error) => { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); console.error(error); });
}

function addNewMember() { const n = prompt("ì´ë¦„:"); if(n && n.trim()) { if(containsBannedWords(n)) return alert("ë¶€ì ì ˆí•œ ì´ë¦„"); membersRef.push({id:`member_${Date.now()}`, name:n.trim(), type:\"member\", color:getRandomColor(), prayers:[], rotation:0, rotationDirection:1}); } }
function updateMemberColor(v) { if(currentMemberData) membersRef.child(currentMemberData.firebaseKey).update({color: v}); }
function deleteMember() { if(currentMemberData && confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { membersRef.child(currentMemberData.firebaseKey).remove(); closePrayerPopup(); }}

function createSafeElement(tag, className, text) { const el = document.createElement(tag); if (className) el.className = className; if (text) el.textContent = text; return el; }

// ==========================================
// [ìˆ˜ì •] ê¸°ë„ì œëª© ë Œë”ë§ í•¨ìˆ˜ (Â·Â·Â· ë”ë³´ê¸° ë©”ë‰´ ì ìš©)
// ==========================================
function renderPrayers() {
    const list = document.getElementById("prayer-list"); 
    list.innerHTML = "";
    
    if(!currentMemberData || !currentMemberData.prayers) { 
        list.innerHTML = "<p style='text-align:center; margin-top:20px;'>ê¸°ë„ì œëª©ì„ ë‚˜ëˆ ì£¼ì„¸ìš”!</p>"; 
        return; 
    }

    const displayList = currentMemberData.prayers.map((p, index) => ({ ...p, originalIndex: index }));
    displayList.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));

    displayList.forEach((p) => {
        const i = p.originalIndex;
        const div = createSafeElement("div", "prayer-card");
        if (p.isPinned) div.classList.add("pinned"); 

        // 1. [í—¤ë”] ì™¼ìª½(ê³ ì •+ë‚ ì§œ) | ì˜¤ë¥¸ìª½(Â·Â·Â· ë”ë³´ê¸°)
        const header = createSafeElement("div", "prayer-header");
        header.style.display = "flex";
        header.style.justifyContent = "space-between";
        header.style.alignItems = "center";

        const headerLeft = createSafeElement("div");
        headerLeft.style.display = "flex";
        headerLeft.style.alignItems = "center";
        headerLeft.style.gap = "8px"; 

        const pinLabel = p.isPinned ? "ğŸ“Œ í•´ì œ" : "ğŸ“ ê³ ì •";
        const pinBtn = createSafeElement("button", "text-btn", pinLabel);
        pinBtn.onclick = () => togglePin(i);
        pinBtn.style.color = p.isPinned ? "#E65100" : "#aaa";
        headerLeft.appendChild(pinBtn);

        const dateSpan = createSafeElement("span", "", p.date);
        dateSpan.style.color = "#8D6E63";
        headerLeft.appendChild(dateSpan);

        // [í•µì‹¬] ë”ë³´ê¸°(Â·Â·Â·) ë²„íŠ¼ ë° ë“œë¡­ë‹¤ìš´ ë©”ë‰´
        const moreWrapper = document.createElement("div");
        moreWrapper.style.position = "relative";
        const moreBtn = createSafeElement("button", "more-btn", "Â·Â·Â·");
        
        const optionsMenu = createSafeElement("div", "more-options");
        optionsMenu.id = `opt-${i}`;

        const optEdit = createSafeElement("button", "opt-btn", "ğŸ“ ìˆ˜ì •");
        optEdit.onclick = (e) => { e.stopPropagation(); editPrayer(i); optionsMenu.classList.remove('active'); };

        const optDel = createSafeElement("button", "opt-btn del-opt", "ğŸ—‘ï¸ ì‚­ì œ");
        optDel.onclick = (e) => { e.stopPropagation(); deletePrayer(i); optionsMenu.classList.remove('active'); };

        optionsMenu.appendChild(optEdit);
        optionsMenu.appendChild(optDel);
        
        moreBtn.onclick = (e) => {
            e.stopPropagation();
            document.querySelectorAll('.more-options').forEach(el => {
                if(el.id !== `opt-${i}`) el.classList.remove('active');
            });
            optionsMenu.classList.toggle('active');
        };

        moreWrapper.appendChild(moreBtn);
        moreWrapper.appendChild(optionsMenu);

        header.appendChild(headerLeft);
        header.appendChild(moreWrapper);

        // 2. [ë³¸ë¬¸] ë‚´ìš©
        const content = createSafeElement("div", "prayer-content", p.content);

        // 3. [í•˜ë‹¨] ë‹µê¸€ ë²„íŠ¼ë§Œ ë°°ì¹˜
        const actionGroup = createSafeElement("div", "action-group");
        const replyBtn = createSafeElement("button", "text-btn", "ğŸ’¬ ë‹µê¸€");
        replyBtn.onclick = () => addReply(i);
        replyBtn.style.color = "#FF7043"; 
        replyBtn.style.fontWeight = "bold";
        actionGroup.appendChild(replyBtn);
        
        div.appendChild(header); 
        div.appendChild(content); 
        div.appendChild(actionGroup);

        // ë‹µê¸€ ì„¹ì…˜ ë Œë”ë§
        if (p.replies) {
            const replySection = createSafeElement("div", "reply-section");
            p.replies.forEach((r, rIdx) => { 
                const rItem = createSafeElement("div", "reply-item");
                rItem.style.display = "flex"; rItem.style.justifyContent = "space-between";
                const textSpan = createSafeElement("span", "", "ğŸ’¬ " + r.content); textSpan.style.flex = "1";
                const delBtn = document.createElement("button");
                delBtn.innerHTML = "&times;"; delBtn.style.cssText = "border:none; background:none; color:#aaa; cursor:pointer; font-size:1.2rem; padding:0 0 0 10px;";
                delBtn.onclick = function() { deleteReply(i, rIdx); };
                rItem.appendChild(textSpan); rItem.appendChild(delBtn); replySection.appendChild(rItem); 
            });
            div.appendChild(replySection);
        }
        list.appendChild(div);
    });
}

// ë‹µê¸€ ì‚­ì œ ë° ê³ ì •, ê¸°íƒ€ ê¸°ë„ ê¸°ëŠ¥ë“¤
function deleteReply(prayerIdx, replyIdx) {
    if(confirm("ì´ ë‹µê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        currentMemberData.prayers[prayerIdx].replies.splice(replyIdx, 1);
        membersRef.child(currentMemberData.firebaseKey).update({prayers: currentMemberData.prayers}).then(() => renderPrayers());
    }
}
function togglePin(index) {
    if (!currentMemberData) return;
    const currentState = currentMemberData.prayers[index].isPinned || false;
    currentMemberData.prayers[index].isPinned = !currentState;
    membersRef.child(currentMemberData.firebaseKey).update({prayers: currentMemberData.prayers}).then(() => renderPrayers());
}
function deletePrayer(i) { if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { currentMemberData.prayers.splice(i, 1); const updateData = currentMemberData.prayers.length > 0 ? currentMemberData.prayers : []; membersRef.child(currentMemberData.firebaseKey).update({prayers: updateData}).then(() => renderPrayers()); } }
function editPrayer(i) { const v = prompt("ìˆ˜ì •:", currentMemberData.prayers[i].content); if(v) { if(containsBannedWords(v)) return alert("ë¶€ì ì ˆí•œ ë‚´ìš©"); currentMemberData.prayers[i].content = v; membersRef.child(currentMemberData.firebaseKey).update({prayers:currentMemberData.prayers}).then(() => renderPrayers()); } }
function addPrayer() { const v = document.getElementById(\"new-prayer\").value.trim(); if(v) { if(containsBannedWords(v)) return alert(\"ë¶€ì ì ˆí•œ ë‚´ìš©\"); const p = currentMemberData.prayers||[]; p.unshift({content:v, date:new Date().toISOString().split('T')[0]}); membersRef.child(currentMemberData.firebaseKey).update({prayers:p}); document.getElementById(\"new-prayer\").value=\"\"; } }
function addReply(i) { const v = prompt(\"ë‹µê¸€:\"); if(v) { if(containsBannedWords(v)) return alert(\"ë¶€ì ì ˆí•œ ë‚´ìš©\"); if(!currentMemberData.prayers[i].replies) currentMemberData.prayers[i].replies=[]; currentMemberData.prayers[i].replies.push({content:v}); membersRef.child(currentMemberData.firebaseKey).update({prayers:currentMemberData.prayers}); } }

// ì±„íŒ… ë° ë‚ ì”¨ ë“± ê¸°ì¡´ì˜ ë‚˜ë¨¸ì§€ ì½”ë“œë“¤ (gameLoop ë“±) ìœ ì§€...
// [ê¸°ì¡´ íŒŒì¼ ë’·ë¶€ë¶„ ì½”ë“œë“¤ ìƒëµ ì—†ì´ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì—¬ í†µí•©í•˜ì„¸ìš”]
