<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>연천장로교회 청년부: 함께 기도해요</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="style.css?v=20">
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body id="body">
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">기도 네트워크 연결 중...</div>
    </div>

    <button class="camp-btn top-ui-common" onclick="event.stopPropagation(); toggleCampPopup()">⛺ 2026 캠프</button>
    <div class="online-counter top-ui-common">
        <div class="online-dot"></div>
        <span id="online-count">접속 중...</span>
    </div>

    <canvas id="weather-canvas"></canvas>
    <div id="visualization"></div>

    <div id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src="" alt=""></div>
    <div id="update-toast" class="system-toast" onclick="window.location.reload(true)">🔄 새 버전 업데이트</div>
    <div id="weather-toast" class="system-toast"><span id="weather-text">날씨 로딩 중...</span></div>

    <div id="menu-container">
        <button class="float-btn menu-main-btn" onclick="event.stopPropagation(); toggleFabMenu()">☰</button>
        <button class="float-btn sub-btn settings-btn" onclick="event.stopPropagation(); openSettingsModal()">⚙️</button>
        <button class="float-btn sub-btn add-member-btn" onclick="event.stopPropagation(); addNewMember()">➕</button>
    </div>
    <button class="chat-btn float-btn" onclick="event.stopPropagation(); toggleChatPopup()">💬<div id="chat-badge" class="chat-badge"></div></button>
    
    <div id="admin-modal" onclick="closeAdminModal(event)">
        <div class="admin-box" onclick="event.stopPropagation()">
            <h3>관리자 인증</h3>
            <input type="password" id="admin-pw" placeholder="비밀번호">
            <button class="submit-btn" onclick="checkAdmin()">확인</button>
        </div>
    </div>
    
    <div id="color-modal" onclick="closeColorModal()">
        <div class="color-box" onclick="event.stopPropagation()">
            <h3>색상 선택</h3>
            <div class="color-grid" id="color-grid"></div>
            <button class="submit-btn" onclick="closeColorModal()">닫기</button>
        </div>
    </div>

    <div id="camp-popup" class="popup-overlay" onclick="toggleCampPopup()">
        <div class="popup-content" onclick="event.stopPropagation()">
            <div class="popup-header"><h2>2026 부흥세대 캠프</h2><button class="close-btn" onclick="toggleCampPopup()">&times;</button></div>
            <div style="overflow-y:auto; flex:1; padding:10px;">
                <img src="https://images.weserv.nl/?url=revival.slim153.com/main/data/editor/2512/b301d4d1631a2282d790dfa909122db3_1764730167_2768.jpg" style="width:100%; border-radius:10px; margin-bottom:10px;" onclick="openLightbox(this.src)">
            </div>
        </div>
    </div>

    <div id="chat-popup" class="popup-overlay" onclick="toggleChatPopup()">
        <div class="popup-content" onclick="event.stopPropagation()">
            <div class="popup-header">
                <h2>소통방</h2>
                <button id="noti-btn" onclick="toggleNotification()" style="font-size:0.8rem; padding:5px;">🔔 알림 켜기</button>
                <button class="close-btn" onclick="toggleChatPopup()">&times;</button>
            </div>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-msg" placeholder="메시지 입력..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button class="chat-send-btn" onclick="sendChatMessage()">전송</button>
            </div>
        </div>
    </div>

    <div id="prayer-popup" class="popup-overlay" onclick="closePrayerPopup()">
        <div class="popup-content" onclick="event.stopPropagation()">
            <div class="popup-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h2 id="panel-name">이름</h2>
                    <button class="edit-name-btn" onclick="editProfile()">편집</button>
                    <div id="current-color-display" class="color-trigger-btn" onclick="openColorModal()"></div>
                </div>
                <button class="close-btn" onclick="closePrayerPopup()">&times;</button>
            </div>
            <div id="prayer-list"></div>
            <div class="prayer-input-area">
                <div class="prayer-verse">"두세 사람이 내 이름으로 모인 곳에는 나도 그들 중에 있느니라"</div>
                <div class="prayer-input-row">
                    <input type="text" id="new-prayer" placeholder="기도제목 입력...">
                    <button class="prayer-send-btn" onclick="addPrayer()">🙏</button>
                </div>
                <div style="text-align:right;"><button class="delete-member-btn" onclick="deleteMember()">멤버 삭제</button></div>
            </div>
        </div>
    </div>

    <div id="profile-edit-modal" class="popup-overlay" onclick="closeProfileEditModal()">
        <div class="popup-content" style="height:auto; padding:20px;" onclick="event.stopPropagation()">
            <h3>프로필 편집</h3>
            <div class="profile-upload-container">
                <img id="edit-profile-preview" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid #ddd;">
                <input type="file" id="profile-file-input" accept="image/*" onchange="handleProfileFileSelect(event)" style="margin-top:10px;">
            </div>
            <input type="text" id="edit-profile-name" class="profile-name-input" placeholder="이름" style="width:100%; padding:10px; margin-top:10px;">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-reset" onclick="closeProfileEditModal()" style="flex:1;">취소</button>
                <button class="btn-save" onclick="saveProfileChanges()" style="flex:1;">저장</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="popup-overlay" onclick="closeSettingsModal()">
        <div class="popup-content" style="height:auto; padding:20px;" onclick="event.stopPropagation()">
            <div class="popup-header"><h2>설정</h2><button class="close-btn" onclick="closeSettingsModal()">&times;</button></div>
            <div class="settings-list">
                <div class="settings-item"><span>🔔 알림</span><input type="checkbox" id="setting-noti-toggle" onchange="handleNotiToggle(this)"></div>
                <div class="settings-item"><span>🔄 초기화</span><button class="setting-action-btn" onclick="forceRefresh()">새로고침</button></div>
                <div class="settings-item"><span>🔒 관리자</span><input type="checkbox" id="setting-admin-toggle" onchange="handleAdminToggle(this)"></div>
            </div>
            <div style="text-align:center; margin-top:20px; color:#aaa;">v20 Integrated</div>
        </div>
    </div>

    <script src="script.js?v=20"></script>
</body>
</html>
